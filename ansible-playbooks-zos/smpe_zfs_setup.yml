################################################################################
# Playbook: SMP/E ZFS Setup
# Purpose: Creates and mounts SMP/E ZFS filesystem on z/OS
################################################################################
---
- name: SMP/E ZFS Setup
  hosts: z31c_s0w1
  collections:
    - ibm.ibm_zos_core
  gather_facts: no
  vars:
    # System configuration
    zfs_name: SMPE.SMPNTS.ZFS
    mount_point: /u/smpe/smpnts
    primary_space: 100
    secondary_space: 50
    
    # Default permissions for mount point
    dir_mode: '0755'
    
    # Timeout settings
    mount_timeout: 300
    command_timeout: 60
  environment: "{{ environment_vars }}"
  pre_tasks:
    - name: Verify connectivity
      zos_ping:
      register: ping_result
      failed_when: ping_result.failed
      
    - name: Check if mount point exists
      stat:
        path: "{{ mount_point }}"
      register: mount_point_stat
      
    - name: Check if ZFS dataset exists
      zos_data_set:
        name: "{{ zfs_name }}"
        state: present
        type: "zfs"
      register: zfs_exists
      ignore_errors: true
      
  tasks:
    - name: Unmount existing ZFS if present
      zos_mount:
        src: "{{ zfs_name }}"
        path: "{{ mount_point }}"
        fs_type: "zfs"
        state: unmounted
      ignore_errors: true
      when: not zfs_exists.failed
        
    - name: Create ZFS
      zos_data_set:
        name: "{{ zfs_name }}"
        type: "zfs"
        space_primary: "{{ primary_space }}"
        space_secondary: "{{ secondary_space }}"
        space_type: cyl
        replace: yes
      register: zfs_creation
      
    - name: Create mount point directory
      file:
        path: "{{ mount_point }}"
        state: directory
        mode: "{{ dir_mode }}"
        recurse: yes
      when: not mount_point_stat.stat.exists
      
    - name: Mount ZFS
      zos_mount:
        src: "{{ zfs_name }}"
        path: "{{ mount_point }}"
        fs_type: "zfs"
        state: mounted
      register: mount_result
      retries: 3
      delay: 10
      until: mount_result is not failed
      
  post_tasks:
    - name: Verify ZFS mount
      shell: df -k "{{ mount_point }}"
      register: df_result
      failed_when: mount_point not in df_result.stdout
      
    - name: Display setup summary
      debug:
        msg: 
          - "SMP/E ZFS setup completed successfully:"
          - "- ZFS dataset: {{ zfs_name }}"
          - "- Mount point: {{ mount_point }}"
          - "- Primary space: {{ primary_space }} cyl"
          - "- Secondary space: {{ secondary_space }} cyl"
      when: mount_result is success
      
    - name: Display setup failure
      debug:
        msg: "SMP/E ZFS setup failed. Check previous task results for details."
      when: mount_result is failed