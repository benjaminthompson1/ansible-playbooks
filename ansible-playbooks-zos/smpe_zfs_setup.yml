################################################################################
# Playbook: SMP/E ZFS Setup
# Purpose: Creates and mounts SMP/E ZFS filesystem on z/OS
# Usage: ansible-playbook -i inventories/inventory.yml smpe_zfs_setup.yml
# Prerequisites: 
#   - IBM z/OS Core collection installed
#   - Valid z/OS credentials configured
#   - Appropriate permissions for ZFS operations
################################################################################
---
- name: SMP/E ZFS Setup
  hosts: z31c_s0w1
  collections:
    - ibm.ibm_zos_core
  gather_facts: no

  environment: "{{ environment_vars }}"
  vars:
    zfs_name: SMPE.SMPNTS.ZFS
    mount_point: /u/smpe/smpnts
    primary_cylinders: 100
    secondary_cylinders: 50

  tasks:
    - name: Create ZFS dataset
      zos_data_set:
        name: "{{ zfs_name }}"
        type: zfs
        space_primary: "{{ primary_cylinders }}"
        space_secondary: "{{ secondary_cylinders }}"
        space_type: cyl
        state: present

    - name: Format the ZFS
      zos_mvs_raw:
        pgm: IOEAGFMT
        parm: "-aggregate {{ zfs_name }} -compat"
      register: format_result

    - name: Create mount point directory
      file:
        path: "{{ mount_point }}"
        state: directory
        mode: '0755'

    - name: Mount the ZFS
      zos_mount:
        src: "{{ zfs_name }}"
        path: "{{ mount_point }}"
        fs_type: ZFS
        state: present
        persistent: yes
